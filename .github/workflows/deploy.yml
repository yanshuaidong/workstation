# GitHub Actions 自动部署配置
name: Deploy to Production

on:
  push:
    branches: [ main, master ]  # 当推送到main或master分支时触发
  workflow_dispatch:  # 允许手动触发

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      
    - name: Deploy to server
      uses: appleboy/ssh-action@v0.1.5
      with:
        host: ${{ secrets.HOST }}
        username: ${{ secrets.USERNAME }}
        key: ${{ secrets.PRIVATE_KEY }}
        port: ${{ secrets.PORT }}
        script: |
          cd /opt/futures-system
          
          # 备份当前版本
          echo "创建备份..."
          ./deploy.sh backup
          
          # 拉取最新代码
          echo "拉取最新代码..."
          git pull origin main
          
          # 重新部署
          echo "重新部署服务..."
          ./deploy.sh restart
          
          # 检查部署状态
          echo "检查部署状态..."
          sleep 10
          ./deploy.sh status
          
          echo "部署完成！"
