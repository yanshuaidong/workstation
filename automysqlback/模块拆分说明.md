# 期货数据更新系统 - 模块拆分说明

## 拆分概述

原来的 `app.py` 文件有 3350 行代码，过于庞大。现在已拆分为 3 个模块化文件：

### 文件结构

```
automysqlback/
├── app.py                           # 主入口文件 (约 470 行)
├── routes/                          # 路由模块目录
│   ├── __init__.py                  # 包初始化文件
│   ├── contracts_routes.py          # 合约管理模块 (约 1650 行)
│   └── news_routes.py               # 新闻管理模块 (约 920 行)
├── app_old.py.bak                   # 旧文件备份
└── ...
```

## 各文件职责

### 1. app.py - 主入口文件

**包含内容：**
- Flask 应用初始化
- 数据库配置和连接函数
- OSS 配置和连接函数
- 环境变量加载和配置验证
- 数据库表初始化函数 `init_database()`
- 系统设置接口（2个）
  - `GET /api/settings` - 获取系统设置
  - `POST /api/settings` - 更新系统设置
- 定时任务相关
  - `auto_update_task()` - 自动更新任务
  - `setup_scheduler()` - 设置定时任务
- 蓝图注册
- 应用启动逻辑

**代码行数：** 约 470 行

---

### 2. contracts_routes.py - 合约管理模块

**包含内容：**

#### 工具函数
- `calculate_technical_indicators()` - 计算技术指标（MACD、RSI、KDJ、布林带）
- `calculate_recommendation()` - 基于技术指标计算推荐操作
- `record_daily_recommendations()` - 记录每日推荐
- `filter_main_contracts()` - 筛选主连合约
- `create_history_table()` - 创建历史数据表
- `fetch_and_store_history_with_retry()` - 获取并存储历史数据（带重试）

#### API接口（合约管理 3个）
- `POST /api/contracts/update-list` - 更新合约列表
- `GET /api/contracts/list` - 获取合约列表
- `GET /api/contracts/list-update-log` - 获取合约列表更新记录

#### API接口（历史数据 5个）
- `POST /api/history/update-all` - 批量更新所有主连历史数据
- `POST /api/history/retry-single` - 重试单个合约历史数据更新
- `GET /api/history/logs` - 获取历史数据更新日志
- `POST /api/history/recalculate-indicators` - 重新计算技术指标
- `GET /api/history/data` - 获取指定合约的历史数据

#### API接口（分时行情 2个）
- `GET /api/intraday/contracts` - 获取分时合约列表
- `GET /api/intraday/data` - 获取分时行情数据

#### API接口（推荐记录 2个）
- `POST /api/recommendations/record` - 手动记录当日推荐
- `GET /api/recommendations/list` - 获取推荐记录列表

**代码行数：** 约 1650 行  
**接口总数：** 12 个

---

### 3. news_routes.py - 新闻管理模块

**包含内容：**

#### 工具函数
- `generate_upload_key()` - 生成OSS上传文件的key
- `generate_signed_upload_url()` - 生成带签名的上传URL
- `generate_signed_access_url()` - 生成带签名的访问URL
- `format_tracking_news()` - 格式化跟踪新闻数据

#### API接口（新闻管理 13个）
- `GET /api/news/stats` - 获取新闻统计信息
- `GET /api/news/list` - 分页查询新闻列表
- `POST /api/news/create` - 创建新闻
- `GET /api/news/detail/<news_id>` - 获取新闻详情
- `PUT /api/news/update/<news_id>` - 更新新闻
- `DELETE /api/news/delete/<news_id>` - 删除新闻
- `GET /api/news/process/unreviewed` - 获取待校验的新闻列表
- `POST /api/news/process/review` - 标记新闻为已校验
- `GET /api/news/process/tracking-list` - 获取需要跟踪的新闻列表
- `POST /api/news/process/update-tracking` - 更新跟踪状态
- `POST /api/news/process/init-tracking` - 初始化跟踪记录

#### API接口（OSS文件管理 2个）
- `POST /api/oss/upload-url` - 获取OSS上传签名URL
- `POST /api/oss/access-url` - 获取OSS访问URL

**代码行数：** 约 920 行  
**接口总数：** 15 个

---

## 技术实现细节

### 蓝图（Blueprint）使用

使用 Flask 的 Blueprint 机制实现模块化：

```python
# routes/contracts_routes.py
contracts_bp = Blueprint('contracts', __name__)

@contracts_bp.route('/contracts/list', methods=['GET'])
def get_contracts_list():
    # ...

# routes/news_routes.py
news_bp = Blueprint('news', __name__)

@news_bp.route('/news/list', methods=['GET'])
def get_cls_news_list():
    # ...

# routes/__init__.py - 统一导出
from .contracts_routes import contracts_bp
from .news_routes import news_bp
__all__ = ['contracts_bp', 'news_bp']

# app.py - 注册蓝图
from routes import contracts_bp, news_bp
app.register_blueprint(contracts_bp, url_prefix='/api')
app.register_blueprint(news_bp, url_prefix='/api')
```

### 共享资源传递

通过 `app.config` 传递共享的数据库连接和OSS连接函数：

```python
# app.py
app.config['get_db_connection'] = get_db_connection
app.config['get_oss_bucket'] = get_oss_bucket

# contracts_routes.py / news_routes.py
from flask import current_app
get_db_connection = current_app.config['get_db_connection']
get_oss_bucket = current_app.config['get_oss_bucket']
```

### URL路由

所有API路由保持不变，向后兼容：

- **系统设置：** `/api/settings`
- **合约相关：** `/api/contracts/*`, `/api/history/*`, `/api/intraday/*`, `/api/recommendations/*`
- **新闻相关：** `/api/news/*`, `/api/oss/*`

---

## 拆分优势

1. **代码可维护性提升**
   - 单文件从 3350 行减少到最大 1650 行
   - 职责清晰，易于理解和修改

2. **团队协作友好**
   - 不同开发人员可以并行开发不同模块
   - 减少代码冲突

3. **测试更容易**
   - 可以针对单个模块编写测试
   - 模块间依赖清晰

4. **性能优化**
   - 按需加载模块
   - 便于独立优化

5. **代码复用**
   - 工具函数集中管理
   - 便于跨模块复用

6. **目录结构清晰**
   - 路由模块统一放在 `routes/` 文件夹
   - 主入口文件 `app.py` 更简洁
   - 便于未来扩展新的路由模块

---

## 注意事项

### 1. 导入路径

路由模块已组织在 `routes/` 文件夹中，通过包导入：

```python
# app.py
from routes import contracts_bp, news_bp
```

如果遇到导入问题，确保在项目根目录运行：

```bash
cd /path/to/automysqlback
python app.py
```

### 2. 数据库连接

所有模块使用相同的数据库配置，通过 `current_app.config` 获取连接函数。

### 3. 日志记录

每个模块使用自己的 logger：

```python
logger = logging.getLogger(__name__)
```

### 4. 向后兼容

所有API接口路径保持不变，客户端无需修改。

---

## 启动方式

### 开发模式

```bash
python app.py
```

或使用 start.py（推荐）：

```bash
python start.py
```

### 生产模式

```bash
gunicorn -c gunicorn_config.py app:app
```

---

## 验证结果

✅ 代码拆分完成  
✅ 无 linter 错误  
✅ 所有接口路径保持不变  
✅ 向后兼容，无需修改客户端代码  

---

**拆分完成时间：** 2025-11-20  
**拆分工具：** Cursor AI

