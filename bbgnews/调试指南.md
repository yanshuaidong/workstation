# 🐛 Bloomberg News Interceptor 调试指南

## 📍 查看日志的三个位置

### 1. Content Script 日志（页面上的拦截器）

**在哪看：** Bloomberg 页面的开发者工具

**步骤：**
1. 访问 https://www.bloomberg.com/latest
2. 按 `F12` 打开开发者工具
3. 切换到 `Console` 标签
4. 刷新页面

**应该看到的日志：**
```
🚀 Bloomberg API拦截器已加载
✅ Fetch 和 XHR 拦截器已安装
🎯 监控目标: /lineup-next/api/stories
```

**当API被调用时：**
```
🎯 拦截到 Bloomberg Stories API: https://www.bloomberg.com/lineup-next/api/stories?...
📦 API响应数据: {stories: Array(25), ...}
✅ 数据已保存到 storage
```

---

### 2. Background Script 日志（后台服务）

**在哪看：** 扩展管理页面

**步骤：**
1. 打开 `chrome://extensions/`
2. 开启右上角「**开发者模式**」
3. 找到 "Bloomberg News Interceptor"
4. 点击蓝色链接「**Service Worker**」或「**查看视图：Service Worker**」
5. 会弹出开发者工具窗口

**应该看到的日志：**
```
✅ Bloomberg News Interceptor 已安装
📝 Content Script 将自动在 Bloomberg 页面上运行
```

**拦截成功时：**
```
✅ 收到拦截的API数据:
   - URL: https://www.bloomberg.com/lineup-next/api/stories?...
   - 数据大小: 123456 bytes
   - 时间: 2025-11-24T...
```

---

### 3. Popup 弹窗日志（插件界面）

**在哪看：** 弹窗界面的开发者工具

**步骤：**
1. 点击浏览器工具栏上的插件图标打开弹窗
2. 在弹窗上**右键点击**
3. 选择「**检查**」或「**Inspect**」
4. 会弹出开发者工具窗口
5. 查看 `Console` 标签

---

## 🔧 常见问题和解决方法

### ❌ 问题 1：Content Script 没有加载

**症状：**
- 页面 Console 看不到 "🚀 Bloomberg API拦截器已加载"
- 没有任何拦截日志

**可能原因：**
1. 插件没有正确加载或需要刷新
2. Content Script 文件有错误
3. Manifest 配置问题

**解决步骤：**

#### 步骤 1：检查插件是否启用
1. 访问 `chrome://extensions/`
2. 确认 "Bloomberg News Interceptor" 开关是**开启**状态
3. 如果是关闭的，点击开关开启

#### 步骤 2：刷新插件
1. 在 `chrome://extensions/` 页面
2. 找到插件，点击「**刷新**」图标（🔄）
3. 关闭所有 Bloomberg 标签页
4. 重新打开 Bloomberg 网站

#### 步骤 3：检查 Content Script 是否加载
1. 在 Bloomberg 页面按 `F12`
2. 切换到 `Sources` 标签
3. 展开左侧树形目录：`Content Scripts` → `Bloomberg News Interceptor`
4. 应该能看到 `content.js` 文件
5. 如果看不到，说明 Content Script 没有注入

#### 步骤 4：检查 Manifest 配置
确保 `manifest.json` 中有：
```json
"content_scripts": [
  {
    "matches": ["https://www.bloomberg.com/*"],
    "js": ["content.js"],
    "run_at": "document_start"
  }
]
```

#### 步骤 5：检查 Content Script 文件
1. 确认 `content.js` 文件存在于插件文件夹
2. 用文本编辑器打开检查是否有语法错误
3. 检查 Service Worker 日志是否有错误信息

---

### ❌ 问题 2：Content Script 已加载但没有拦截

**症状：**
- 看到 "🚀 Bloomberg API拦截器已加载"
- 但没有看到 "🎯 拦截到 Bloomberg Stories API"

**可能原因：**
1. 页面没有调用目标API
2. API URL 发生了变化
3. 网络请求失败

**解决步骤：**

#### 步骤 1：确认API是否被调用
1. 在页面按 `F12` 打开开发者工具
2. 切换到 `Network` 标签
3. 在过滤器中输入 `stories`
4. 刷新页面
5. 查看是否有 `lineup-next/api/stories` 请求
   - ✅ 如果有：说明API确实被调用了
   - ❌ 如果没有：可能你访问的页面不会调用这个API

#### 步骤 2：尝试访问这些页面
确保访问会调用文章列表API的页面：
- https://www.bloomberg.com/latest
- https://www.bloomberg.com/asia
- https://www.bloomberg.com/europe
- https://www.bloomberg.com/technology

#### 步骤 3：检查API URL是否变化
1. 在 Network 标签中找到实际的API请求
2. 查看完整URL
3. 如果URL路径不是 `/lineup-next/api/stories`，需要修改 `content.js` 中的 `TARGET_API` 变量

---

### ❌ 问题 3：拦截成功但数据没有显示在弹窗

**症状：**
- Console 显示 "✅ 数据已保存到 storage"
- 但打开插件弹窗看不到数据

**解决步骤：**

#### 步骤 1：检查 Storage 权限
确保 `manifest.json` 中有：
```json
"permissions": [
  "storage"
]
```

#### 步骤 2：检查 Storage 内容
1. 在 Bloomberg 页面按 `F12`
2. 切换到 `Application` 标签
3. 展开左侧 `Storage` → `Extension Storage` → 插件ID
4. 查看是否有 `capturedData` 键
5. 如果有数据，说明保存成功

#### 步骤 3：检查 Popup 脚本
1. 打开插件弹窗
2. 在弹窗上右键 → 检查
3. 在 Console 查看是否有错误

#### 步骤 4：手动刷新弹窗
1. 关闭插件弹窗
2. 重新点击插件图标打开
3. 数据应该会显示

---

### ❌ 问题 4：徽章通知没有显示

**症状：**
- 拦截成功但插件图标没有显示 ✓ 标记

**原因：**
- 这是正常的，徽章会在 3 秒后自动消失
- 如果完全没看到，可能是浏览器不支持或有延迟

**不影响功能：**
- 这只是一个视觉提示，不影响核心拦截功能

---

## 🔍 高级调试技巧

### 1. 查看所有 Fetch 请求

在 `content.js` 中临时添加调试代码：

```javascript
window.fetch = async function(...args) {
  const url = typeof args[0] === 'string' ? args[0] : args[0]?.url || '';
  
  // 添加这行，打印所有请求
  console.log('🔍 Fetch 请求:', url);
  
  const response = await originalFetch.apply(this, args);
  // ... 其余代码
```

### 2. 强制拦截测试

在页面 Console 中手动发起测试请求：

```javascript
fetch('https://www.bloomberg.com/lineup-next/api/stories?types=ARTICLE&locale=en&pageNumber=1&limit=25')
  .then(r => r.json())
  .then(data => console.log('测试请求成功:', data));
```

### 3. 检查权限

在页面 Console 中测试 Storage 权限：

```javascript
chrome.storage.local.set({test: 'hello'}, () => {
  console.log('写入测试:', chrome.runtime.lastError || '成功');
  chrome.storage.local.get('test', (result) => {
    console.log('读取测试:', result);
  });
});
```

---

## 📋 完整的调试检查清单

### 安装和配置
- [ ] 插件已在 `chrome://extensions/` 中启用
- [ ] 开发者模式已开启
- [ ] 所有文件都在 `bbgnews` 文件夹中
- [ ] `manifest.json` 配置正确
- [ ] 修改代码后已点击刷新按钮

### Content Script
- [ ] 页面 Console 显示 "🚀 Bloomberg API拦截器已加载"
- [ ] 页面 Console 显示 "✅ Fetch 和 XHR 拦截器已安装"
- [ ] Sources 标签中能看到 `content.js` 文件
- [ ] 没有语法错误或运行时错误

### API 调用
- [ ] Network 标签中能看到 `lineup-next/api/stories` 请求
- [ ] 请求状态码是 200
- [ ] 响应内容是 JSON 格式
- [ ] 访问的页面会触发该API（如 `/latest`）

### 数据存储
- [ ] Console 显示 "✅ 数据已保存到 storage"
- [ ] Application 标签中 Extension Storage 有 `capturedData`
- [ ] Background Script 收到 `API_CAPTURED` 消息

### 弹窗显示
- [ ] 打开弹窗能看到 JSON 数据
- [ ] 数据格式正确，有时间戳
- [ ] 清除按钮可以清除数据
- [ ] 刷新按钮可以重新加载页面

---

## 🆘 还是无法解决？

### 导出调试信息

1. **页面 Console 截图**
   - 按 F12，Console 标签的完整截图

2. **Network 标签截图**
   - 显示是否有 `stories` 请求

3. **扩展页面截图**
   - `chrome://extensions/` 的插件信息

4. **Service Worker 日志**
   - 复制所有日志内容

5. **检查文件完整性**
   - 确认以下文件都存在：
     - `manifest.json`
     - `content.js`
     - `popup.html`
     - `popup.js`
     - `background.js`

### 重新安装插件

1. 在 `chrome://extensions/` 点击「移除」
2. 关闭所有 Bloomberg 标签页
3. 重新「加载已解压的扩展程序」
4. 重新打开 Bloomberg 网站测试

---

## 💡 预防性建议

1. **修改代码后务必刷新插件**
   - 在 `chrome://extensions/` 点击刷新按钮

2. **测试时使用无痕模式**
   - 避免其他扩展干扰
   - 需要在扩展管理页面允许无痕模式

3. **保持开发者工具开启**
   - 方便实时查看日志

4. **使用简单的测试页面**
   - 先确保 `/latest` 页面能正常拦截
   - 再测试其他页面

---

## 📞 获取帮助

如果以上方法都无法解决问题，请提供：
1. 浏览器版本（在 `chrome://version/` 查看）
2. 插件版本（在 `manifest.json` 查看）
3. 所有三个位置的 Console 日志
4. Network 标签的截图
5. 详细的错误描述

祝调试顺利！🎉

