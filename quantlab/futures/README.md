# 期货单边行情识别与机器学习策略 V2.0

基于传统机器学习（LightGBM）的期货趋势预测与多空双向交易策略系统。

---

## 🎯 V2.0 主要改进

相比 V1.0，V2.0 版本进行了全面升级：

### 标签定义优化
- ❌ **旧方法**：识别历史单边行情段，在趋势前/中段打标签（滞后性强）
- ✅ **新方法**：预测未来 N 天的最大收益潜力（前瞻性强）
- **优势**：更符合实际交易逻辑，直接预测盈利机会

### 特征工程增强
- 从 19 个特征 → **60+ 个特征**
- 新增：波动率收缩、多周期突破、资金流向、K线形态、RSI、布林带等
- 更全面捕捉市场特征

### 信号筛选优化
- ❌ **旧方法**：固定阈值 p_long > 0.6（静态）
- ✅ **新方法**：动态百分位阈值 top 5%（自适应）
- **优势**：根据市场状态自动调整，只交易最优质信号

### 风控系统完善
- ❌ **旧方法**：简单止损（ATR倍数）
- ✅ **新方法**：多重风控机制
  - 固定止盈 5% / 固定止损 2%
  - 移动止损 1.5%（锁住利润）
  - 最大持仓期 10 天
- **优势**：更科学的风险控制，减少大额亏损

### 双向交易支持
- ❌ **旧方法**：仅支持多头策略
- ✅ **新方法**：多空双向交易，独立模型
- **优势**：捕捉更多交易机会，提高资金利用率

### 仓位管理
- 新增：最大持仓数量限制（5个品种）
- 新增：单笔仓位占比控制（20%）
- 新增：信号优先级排序（按概率）
- **优势**：分散风险，避免过度集中

---

## 📁 项目结构

```
quantlab/
├── futures_trend_ml.py    # 主程序代码
├── 量化单边行情设计.md      # 设计文档
├── README.md              # 本说明文档
├── models/                # 模型保存目录（运行后生成）
│   ├── long_model_lgbm.pkl
│   └── short_model_lgbm.pkl
└── output/                # 输出目录（运行后生成）
    └── equity_curve.png
```

---

## 🚀 快速开始

### 1. 环境依赖

```bash
pip install pandas numpy scikit-learn lightgbm matplotlib joblib
```

**注意**：如果无法安装 LightGBM，程序会自动使用 `sklearn.ensemble.GradientBoostingClassifier` 替代。

### 2. 运行程序

```bash
cd quantlab
python futures_trend_ml.py
```

### 3. 数据要求

程序默认读取 `../database/futures/futures.db` SQLite 数据库。

数据库结构详见 `database/futures/README.md`。

---

## 📊 核心功能

### 1. 数据读取与整合

- 从 `contracts_main` 表读取所有活跃合约
- 遍历各合约的 `hist_{symbol}` 历史数据表
- 统一字段名称，合并为总 DataFrame
- 自动剔除数据量不足（< 250 交易日）的品种

### 2. 标签生成（V2.0 改进）

**新标签定义**：预测未来 N 天的最大收益潜力

| 标签 | 定义 | 含义 |
|-----|------|------|
| label_long = 1 | 未来 N 天最大上涨幅度 >= 阈值（如 3%） | 做多机会 |
| label_short = 1 | 未来 N 天最大下跌幅度 >= 阈值（如 3%） | 做空机会 |
| label = 0 | 未达到阈值 | 无交易机会 |

**关键参数**：
- `future_days = 5`：预测未来 5 天
- `long_threshold = 0.03`：多头收益阈值 3%
- `short_threshold = 0.03`：空头收益阈值 3%

### 3. 特征工程（增强版）

共生成 **60+ 个特征**，涵盖多个维度，全部使用历史数据：

| 类别 | 特征数量 | 主要特征 |
|-----|---------|---------|
| **价格动量** | 5 | 多周期收益率（3/5/10/20日）、动量加速度 |
| **突破信号** | 15 | 多周期（10/20/40日）价格位置、突破高低点、距离指标 |
| **均线系统** | 8 | MA多空排列、价格偏离度（MA20/MA60） |
| **波动率** | 7 | 多周期波动率、波动率收缩、ATR及变化率 |
| **趋势强度** | 6 | 多周期斜率、R²、趋势得分 |
| **成交量** | 5 | 量比、放量突破信号 |
| **持仓量** | 4 | 持仓变化、价涨仓增/价跌仓增（资金流向） |
| **K线形态** | 5 | 实体占比、收盘位置、连续阳阴线 |
| **技术指标** | 5 | RSI、布林带位置及突破 |

**预热期**：前 60 个交易日用于计算滚动指标，从第 61 日开始生成有效样本。

### 4. 数据集划分

采用**固定年份划分**（时间序列严格有序）：

| 数据集 | 时间范围 | 占比 |
|-------|---------|-----|
| 训练集 | 2018-01 ~ 2022-12 | ~71% |
| 验证集 | 2023-01 ~ 2023-12 | ~14% |
| 测试集 | 2024-01 ~ 2024-12 | ~14% |

### 5. 模型训练（双模型架构）

**V2.0 采用双模型架构**：
- **多头模型**：专门预测做多机会（label_long）
- **空头模型**：专门预测做空机会（label_short）

**LightGBM 分类器配置**：

- 自动处理样本不平衡（`scale_pos_weight`）
- 验证集早停（early_stopping_rounds=100）
- 自动寻找最佳概率阈值（最大化 F1-Score）
- 评估指标：AUC、Accuracy、Precision、Recall、F1

**优化超参数**：

```python
{
    'num_leaves': 63,
    'max_depth': 8,
    'learning_rate': 0.03,
    'n_estimators': 1000,
    'subsample': 0.7,
    'colsample_bytree': 0.7,
    'reg_alpha': 0.1,
    'reg_lambda': 0.1
}
```

### 6. 策略回测（V2.0 全面升级）

**多空双向交易策略**：

#### 开仓逻辑
- **信号筛选**：使用动态百分位阈值（默认 top 5%）
  - 多头信号：`p_long >= np.percentile(p_long, 95)`
  - 空头信号：`p_short >= np.percentile(p_short, 95)`
  - 只交易模型最有把握的信号
- **仓位管理**：
  - 最大同时持仓：5 个品种
  - 单笔仓位占比：20%（总资金）
  - 按概率从高到低优先开仓
  - 同一品种不能同时多空

#### 平仓逻辑（多重风控）
1. **固定止盈**：收益达到 5% 立即止盈
2. **固定止损**：亏损达到 2% 立即止损
3. **移动止损**：从最高点回撤超过 1.5% 时止损（锁住利润）
4. **最大持仓期**：持仓超过 10 天自动平仓
5. **信号反转**：可选的反向信号平仓（当前未启用）

#### 交易成本
- **手续费率**：双边 0.03%（开仓 + 平仓）

#### 回测输出指标
- **交易统计**：总交易次数、多空分布、胜率
- **收益指标**：平均单笔收益、盈亏比、累计收益、年化收益
- **风险指标**：最大回撤、夏普比率
- **其他**：平均持仓天数、退出原因分布
- **可视化**：净值曲线图、回撤曲线图、特征重要性图

---

## 📈 输出示例

```
============================================================
期货单边行情识别与机器学习策略 V2.0
============================================================

[数据加载] 发现 76 个活跃合约
[数据加载] 成功加载 52 个品种
[数据加载] 数据日期范围: 2018-01-02 ~ 2024-12-31
[数据加载] 总样本数: 85,000+

[标签生成] 预测未来 5 天
[标签生成] 多头阈值: 3.0%, 空头阈值: 3.0%
[标签生成] 有效样本数: 80,000+
[标签生成] 多头信号 (label_long=1): 12,000+ (15%)
[标签生成] 空头信号 (label_short=1): 11,000+ (14%)

[特征工程] 生成 60+ 个特征
[特征工程] 移除无效数据后样本数: 80,000+

[模型训练] 多头模型验证集评估:
  - AUC:       0.68+
  - Accuracy:  0.86+
  - Precision: 0.35+
  - Recall:    0.28+
  - F1:        0.31+

[模型训练] 空头模型验证集评估:
  - AUC:       0.66+
  - Accuracy:  0.85+
  - Precision: 0.33+
  - Recall:    0.26+

[回测] 使用 top 5% 阈值
[回测] 多头阈值: 0.75+
[回测] 空头阈值: 0.73+

============================================================
回测结果汇总
============================================================
总交易次数: 300+
多头交易: 180+
空头交易: 120+
胜率: 48%+
多头胜率: 50%+
空头胜率: 45%+
平均单笔收益: 0.8%+
盈亏比: 1.5+
累计收益: 25%+
年化收益: 20%+
最大回撤: 6%
夏普比率: 1.2+
平均持仓天数: 6.5

退出原因分布:
  - take_profit: 100 笔, 平均收益 5.2%
  - stop_loss: 120 笔, 平均收益 -2.1%
  - trailing_stop: 50 笔, 平均收益 3.5%
  - max_days: 30 笔, 平均收益 0.5%
```

**注意**：以上数据仅为示例，实际结果取决于数据质量和参数设置。

---

## 🔧 自定义配置

### 修改策略参数

在 `main()` 函数中调整 `StrategyConfig`：

```python
config = StrategyConfig(
    # 标签参数
    future_days=5,           # 预测未来天数（1-10 天）
    long_threshold=0.03,     # 多头收益阈值（如 0.03 = 3%）
    short_threshold=0.03,    # 空头收益阈值
    
    # 特征参数
    warmup_period=60,        # 预热期（建议 60-100）
    
    # 数据划分
    train_end='2022-12-31',  # 训练集结束日期
    valid_end='2023-12-31',  # 验证集结束日期
    
    # 交易参数
    signal_percentile=95,    # 信号阈值百分位（90-99，越高越严格）
    max_holding_days=10,     # 最大持仓天数（5-20）
    stop_loss_pct=0.02,      # 固定止损比例（1%-3%）
    take_profit_pct=0.05,    # 固定止盈比例（3%-8%）
    trailing_stop_pct=0.015, # 移动止损比例（1%-2%）
    fee_rate=0.0003,         # 手续费率
    
    # 仓位管理
    max_positions=5,         # 最大同时持仓数量（3-10）
    position_size=0.2        # 单笔仓位占比（0.1-0.3）
)
```

### 参数调优建议

| 参数类别 | 激进策略 | 保守策略 |
|---------|---------|---------|
| 收益阈值 | 2% | 4%+ |
| 信号百分位 | 90 (top 10%) | 98 (top 2%) |
| 止损比例 | 3% | 1.5% |
| 止盈比例 | 8% | 4% |
| 最大持仓 | 8-10 个 | 3-5 个 |
| 仓位占比 | 25-30% | 15-20% |

---

## 📝 API 参考

### 主要函数

| 函数 | 功能 |
|-----|------|
| `load_history_from_db(db_path)` | 从数据库加载历史数据 |
| `assign_labels(df_all)` | 识别单边行情并打标签 |
| `make_features(df)` | 生成特征 |
| `split_data_by_year(df)` | 按年份划分数据集 |
| `train_long_model(...)` | 训练多头模型 |
| `train_short_model(...)` | 训练空头模型 |
| `predict_proba(df, model, cols)` | 预测概率 |
| `simple_backtest(...)` | 简单策略回测 |

---

## ⚠️ 注意事项

1. **禁止使用深度学习框架**：本项目只使用传统机器学习（LightGBM/sklearn）
2. **时间序列数据**：必须按时间顺序划分数据集，禁止随机打乱
3. **特征泄露**：所有特征只使用过去信息，不会引入未来数据
4. **回测局限**：
   - 未考虑流动性、滑点、冲击成本
   - 假设可以按收盘价成交
   - 未考虑跳空缺口（可能导致止损失效）
   - 未考虑交易所保证金和强平风险
5. **数据质量**：部分品种数据较短（< 250 条），已自动剔除
6. **过拟合风险**：60+ 个特征可能导致过拟合，建议：
   - 使用正则化参数（reg_alpha, reg_lambda）
   - 特征重要性分析，剔除低重要性特征
   - 交叉验证确保模型稳定性
7. **概率阈值**：top 5% 阈值可能过于严格，导致交易频率低，可根据实际调整
8. **市场变化**：历史回测不代表未来表现，市场结构变化会影响策略有效性

---

## ❓ 常见问题

### Q1: p_long > 0.6 是什么意思？这个值在哪设置？

**A**: `p_long` 是模型预测的概率（0-1之间），表示做多机会的可能性。

⚠️ **重要**：V2.0 已不再使用固定阈值 0.6！

- **V1.0**（已废弃）：`p_long > 0.6` 表示概率超过 60% 就开仓
- **V2.0**（当前版本）：使用动态百分位阈值
  ```python
  # 代码中的实现（第 1217-1219 行）
  test_long_threshold = np.percentile(p_long, 95)  # top 5%
  test_short_threshold = np.percentile(p_short, 95)
  ```
  - 只选择概率排名**前 5%** 的信号
  - 阈值会根据当前市场动态调整
  - 可以通过 `config.signal_percentile` 参数修改（95 = top 5%）

**示例**：
- 如果 95 分位数是 0.75，则 `p_long >= 0.75` 才开仓
- 如果 95 分位数是 0.82，则 `p_long >= 0.82` 才开仓

### Q2: 如何调整交易频率？

- **减少交易**：提高 `signal_percentile`（如 98 = top 2%）
- **增加交易**：降低 `signal_percentile`（如 90 = top 10%）
- **调整位置**：`main()` 函数中的 `StrategyConfig`

### Q3: 如何提高胜率？

1. 提高收益阈值：`long_threshold = 0.05`（5%）
2. 提高信号筛选：`signal_percentile = 98`（top 2%）
3. 缩短持仓期：`max_holding_days = 5`
4. 加强止损：`stop_loss_pct = 0.015`（1.5%）

### Q4: 为什么使用 top 5% 而不是固定阈值？

**动态阈值的优势**：
- 适应市场变化：牛市信号多时自动提高标准
- 控制交易频率：确保每期交易数量相对稳定
- 避免过度交易：只选最优质信号

**固定阈值的问题**：
- 市场平静时无交易（所有概率都低）
- 市场剧烈时过度交易（所有概率都高）

### Q5: 如何实盘使用？

⚠️ **警告**：本策略仅供学习研究，实盘需要：

1. **完善回测**：加入滑点、流动性、冲击成本
2. **实时数据**：对接期货行情接口
3. **风控系统**：账户风险、保证金管理
4. **执行系统**：自动下单、异常处理
5. **监控预警**：实时监控持仓和风险
6. **小资金试运行**：验证策略有效性

详见：`实盘使用指南.md`（如果存在）

### Q6: LightGBM 安装失败怎么办？

程序会自动降级使用 `sklearn.GradientBoostingClassifier`：
```python
pip install scikit-learn
```

性能略低于 LightGBM，但核心逻辑一致。

---

## 📄 许可证

本项目仅供学习研究使用，不构成任何投资建议。实盘交易风险自负。

明白！我来创建一个多策略系统：训练3组模型，然后每日扫描时同时用3组参数预测，对比输出。


## 多策略系统说明

### 1️⃣ 训练脚本：`train_multi_strategy.py`

训练3组独立的模型：

| 策略 | 标识 | 核心参数 | 特点 |
|-----|-----|---------|------|
| 🔵 大行情型 | `big_trend` | 预测15天，阈值10%，止盈15% | 盈亏比2.57最高，适合大趋势 |
| 🟢 高阈值型 | `high_threshold` | 预测10天，阈值8%，止盈12% | 回撤4.6%最低，风控最佳 |
| 🟡 超严格型 | `strict` | 预测7天，阈值7%，top 0.3% | 胜率46.6%最高，夏普最高 |

**运行命令：**
```bash
cd D:\ysd\workstation\quantlab
python train_multi_strategy.py
```

模型会保存到 `models/multi_strategy/` 目录。

---

### 2️⃣ 每日扫描：`daily_signal_scanner_multi.py`

同时使用3组模型预测，输出对比结果：

**运行命令：**
```bash
# 扫描最新信号
python daily_signal_scanner_multi.py

# 只显示共识信号（>=2个策略同时推荐）
python daily_signal_scanner_multi.py --consensus

# 指定日期
python daily_signal_scanner_multi.py --date 2024-12-15

# 导出到CSV
python daily_signal_scanner_multi.py --export
```

---

### 3️⃣ 输出示例

```
📊 多策略信号对比分析
============================================================

信号统计:
  - 三策略共识 (⭐⭐⭐): 2 个     ← 最高质量信号
  - 双策略共识 (⭐⭐): 5 个
  - 单策略信号 (⭐): 12 个

🔺 多头信号 (Top 15)
============================================================
品种   共识   策略    现价     大行情    高阈值    超严格    止损    止盈   RSI
AU    ⭐⭐⭐  🔵🟢🟡  580.00   18.5%     16.2%     14.8%   562.60  638.00  65
CU    ⭐⭐    🔵🟢    72500    15.2%     14.1%    (12.8%)  70175   81200   58
...

⭐⭐⭐ 重点推荐（三策略共识）
============================================================
如果三个策略都推荐同一品种，信号质量最高！
```

---

### 4️⃣ 使用建议

1. **⭐⭐⭐ 三策略共识**：最高质量信号，优先交易
2. **🔵+🟢 双共识**：大行情 + 高阈值，适合稳健型
3. **🔵+🟡 双共识**：大行情 + 超严格，适合精准型
4. **止损止盈**：自动取各策略最保守的参数

先运行 `train_multi_strategy.py` 训练模型，然后就可以用 `daily_signal_scanner_multi.py` 每日扫描了！