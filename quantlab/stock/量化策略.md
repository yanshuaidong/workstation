# 量化交易策略 - 开发规范

---

## 🎯 本文档目标

本文档用于指导生成两个核心 Python 文件：

| 文件 | 用途 | 运行频率 |
|:-----|:-----|:---------|
| `train.py` | 训练 LightGBM 模型 | 每月/每季度 |
| `daily_advisor.py` | 读取数据，输出操作建议 | 每日/每周 |

---

## 📁 项目结构

```
quantlab/
├── train.py              # 模型训练脚本
├── daily_advisor.py      # 每日操作建议脚本
├── models/               # 保存训练好的模型
│   └── model.pkl
├── portfolio.json        # 持仓信息（手动维护）
└── 量化策略.md           # 本规范文档
```

---

## 📊 持仓文件格式 (portfolio.json)

```json
{
  "cash": 50000,
  "positions": [
    {
      "symbol": "000681",
      "name": "视觉中国",
      "shares": 1000,
      "buy_price": 15.50,
      "buy_date": "2025-12-10",
      "current_price": 16.20
    }
  ],
  "last_update": "2025-12-18"
}
```

| 字段 | 说明 |
|:-----|:-----|
| `cash` | 可用现金（元） |
| `positions` | 持仓列表 |
| `symbol` | 股票代码 |
| `name` | 股票名称 |
| `shares` | 持有股数 |
| `buy_price` | 买入价格 |
| `buy_date` | 买入日期 |
| `current_price` | 当前价格（手动更新） |
| `last_update` | 最后更新时间 |

---

## 📈 train.py 规范

### 功能要求

1. 从 `database/stock.db` 读取数据
2. 计算特征和标签
3. 训练 LightGBM 模型
4. 保存模型到 `models/model.pkl`

### 标签定义

```
正样本 (label=1)：
├── 未来20个交易日最大涨幅 ≥ 20%
└── 达到最高点前，最大回撤 < 10%

负样本 (label=0)：其他情况
```

### 特征列表（30个）

**价格动量（6个）**
- `ret_5d`, `ret_10d`, `ret_20d`, `ret_60d`
- `high_5d_break`, `high_20d_break`

**均线（9个）**
- `ma5`, `ma10`, `ma20`, `ma60`
- `close_to_ma5`, `close_to_ma20`, `ma5_to_ma20`
- `ma_trend`, `ma20_slope`

**波动率（4个）**
- `atr_20`, `volatility_20`, `amplitude_mean_10`, `vol_contract`

**成交量（6个）**
- `volume_ratio`, `volume_ma5`, `volume_ma20`
- `volume_trend`, `turnover_mean_10`, `amount_rank`

**技术指标（5个）**
- `rsi_14`, `macd`, `macd_signal`, `macd_hist`, `macd_cross`

**位置（4个）**
- `pct_from_high_60`, `pct_from_low_60`
- `price_position_60`, `days_since_high_20`

### 数据划分

| 数据集 | 时间范围 | 用途 |
|:------|:--------|:-----|
| 训练集 | 2018-01 ~ 2022-12 | 模型学习 |
| 验证集 | 2023-01 ~ 2023-12 | 调参优化 |
| 测试集 | 2024-01 ~ 2024-12 | 最终评估 |

### 模型参数

```python
params = {
    'objective': 'binary',
    'metric': 'auc',
    'num_leaves': 31,
    'learning_rate': 0.05,
    'feature_fraction': 0.8,
    'bagging_fraction': 0.8,
    'bagging_freq': 5,
    'n_estimators': 500,
    'early_stopping_rounds': 50
}
```

---

## 🔮 daily_advisor.py 规范

### 功能要求

1. 加载训练好的模型 `models/model.pkl`
2. 读取持仓文件 `portfolio.json`
3. 从数据库获取最新行情数据
4. 计算所有股票的预测概率
5. **输出操作建议**

### 输出格式

```
========================================
📅 交易建议报告 - 2025-12-18
========================================

💼 当前持仓分析：
┌─────────┬──────────┬────────┬────────┬────────┬──────────┐
│ 代码    │ 名称     │ 买入价 │ 现价   │ 盈亏%  │ 建议     │
├─────────┼──────────┼────────┼────────┼────────┼──────────┤
│ 000681  │ 视觉中国 │ 15.50  │ 16.20  │ +4.52% │ ✅ 继续持有 │
└─────────┴──────────┴────────┴────────┴────────┴──────────┘

🎯 今日高概率股票 TOP 5：
┌─────┬─────────┬──────────┬────────┬────────┐
│ 排名│ 代码    │ 名称     │ 概率   │ 是否推荐│
├─────┼─────────┼──────────┼────────┼────────┤
│ 1   │ 002230  │ 科大讯飞 │ 0.78   │ ⭐ 推荐 │
│ 2   │ 000681  │ 视觉中国 │ 0.72   │ ⭐ 持有中│
│ 3   │ 300750  │ 宁德时代 │ 0.68   │ ⭐ 推荐 │
│ 4   │ 600519  │ 贵州茅台 │ 0.61   │        │
│ 5   │ 000858  │ 五粮液   │ 0.58   │        │
└─────┴─────────┴──────────┴────────┴────────┘

📋 操作建议：
1. 000681 视觉中国：继续持有（仍在TOP榜单，盈利中）
2. 002230 科大讯飞：可考虑买入（概率最高 0.78）

⚠️ 风险提示：
- 当前持仓盈利 +4.52%，未触发止盈(+25%)或止损(-10%)

========================================
```

### 操作建议逻辑

```
对于【持仓股票】：
├── 盈利 ≥ +25%  → 🔴 建议止盈卖出
├── 亏损 ≤ -10%  → 🔴 建议止损卖出
├── 不在 Top 5 且持有满3周 → 🟡 建议换股
└── 其他情况 → ✅ 继续持有

对于【新股推荐】：
├── 概率 ≥ 0.65 → ⭐ 强烈推荐
├── 概率 ≥ 0.55 → 可关注
└── 概率 < 0.55 → 不推荐

空仓时：
└── 无 P ≥ 0.65 的股票 → 建议空仓等待
```

### 过滤规则

选股时排除：
- ST 股票（名称包含 ST）
- 上市不足 60 个交易日
- 日均成交额 < 2000 万
- 北交所股票（market = BJ）

---

## 📦 数据库结构

**数据库**：`database/stock.db`

**stock_main 表**：
| 字段 | 说明 |
|:-----|:-----|
| symbol | 股票代码 |
| name | 股票名称 |
| market | 市场（SH/SZ/BJ） |

**hist_{symbol} 表**：
| 字段 | 说明 |
|:-----|:-----|
| date | 交易日期 |
| open, high, low, close | OHLC 价格 |
| volume | 成交量 |
| amount | 成交额 |
| amplitude | 振幅(%) |
| pct_change | 涨跌幅(%) |
| turnover | 换手率(%) |

---

## 📦 依赖包

```
pandas>=1.5.0
numpy>=1.21.0
lightgbm>=3.3.0
scikit-learn>=1.0.0
joblib>=1.1.0
tabulate>=0.9.0
```

---

## ✅ 开发检查清单

### train.py
- [ ] 正确读取 stock.db 数据
- [ ] 实现所有 30 个特征计算
- [ ] 正确计算标签（20%涨幅 + 10%回撤限制）
- [ ] 按时间划分训练/验证/测试集
- [ ] 训练并保存模型
- [ ] 输出模型评估指标（AUC, 准确率等）

### daily_advisor.py
- [ ] 加载模型
- [ ] 读取 portfolio.json
- [ ] 获取最新行情数据
- [ ] 计算所有股票概率
- [ ] 分析持仓盈亏状态
- [ ] 输出格式化的操作建议
- [ ] 标注止盈/止损/换股信号
