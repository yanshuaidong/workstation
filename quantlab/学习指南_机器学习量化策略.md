# 🎓 机器学习量化策略学习指南

> 这份指南帮助你理解 `futures_trend_ml.py` 的核心逻辑和评价标准

---

## 📋 目录

1. [核心思想：5分钟理解全局](#第一章核心思想)
2. [代码模块详解](#第二章代码模块详解)
3. [如何评价结果好坏](#第三章如何评价结果)
4. [学习路径建议](#第四章学习路径)

---

## 第一章：核心思想

### 🎯 这个代码在解决什么问题？

> **"能否根据历史数据的各种指标，预测哪些品种在未来几天会大涨/大跌？"**

### 📊 整体流程图

```
┌────────────────────────────────────────────────────────────────────┐
│                     机器学习量化策略的5个步骤                        │
├────────────────────────────────────────────────────────────────────┤
│                                                                    │
│  ① 数据准备          从数据库读取历史K线数据                        │
│       ↓              (日期、开高低收、成交量、持仓量)                │
│                                                                    │
│  ② 定义标签          什么是"好的交易机会"？                         │
│       ↓              → 未来5天最大涨幅 ≥ 3% 的情况                  │
│                                                                    │
│  ③ 特征工程          用什么指标来预测？                             │
│       ↓              → 50+个技术指标（动量、均线、波动率等）         │
│                                                                    │
│  ④ 模型训练          让机器学习规律                                 │
│       ↓              → 输入特征 → 输出"是好机会的概率"              │
│                                                                    │
│  ⑤ 回测验证          在历史数据上模拟交易                           │
│                      → 看策略是否真的能赚钱                         │
│                                                                    │
└────────────────────────────────────────────────────────────────────┘
```

### 🤔 传统策略 vs 机器学习策略

| | 传统策略（规则型） | 机器学习策略 |
|---|---|---|
| **规则来源** | 人定义的（如：RSI<30就买） | 机器从数据中学习 |
| **复杂度** | 简单，容易理解 | 复杂，但能发现隐藏规律 |
| **风险** | 容易过拟合到特定行情 | 需要大量数据，也可能过拟合 |
| **例子** | `if RSI < 30: 买入` | `模型(50个指标) → 买入概率` |

---

## 第二章：代码模块详解

### 📁 代码结构概览

| 代码行号 | 函数名 | 功能 | 重要程度 |
|---------|--------|------|---------|
| 97-177 | `load_history_from_db()` | 加载历史数据 | ⭐⭐ |
| 218-274 | `assign_labels_v2()` | **生成标签** | ⭐⭐⭐⭐⭐ |
| 332-534 | `make_features_v2()` | **特征工程** | ⭐⭐⭐⭐ |
| 541-555 | `split_data_by_year()` | 数据集划分 | ⭐⭐ |
| 567-691 | `train_model()` | 模型训练 | ⭐⭐⭐ |
| 746-953 | `backtest_v2()` | **回测系统** | ⭐⭐⭐⭐ |
| 956-1035 | `analyze_backtest_results()` | 结果分析 | ⭐⭐⭐ |

---

### 2.1 标签生成（最关键！）

**位置**: 第218-274行 `assign_labels_v2()`

**核心问题**: 什么算"好的交易机会"？

**我们的定义**:
```python
# 如果今天买入，未来5天内最高价涨幅 >= 3%
# 就认为这是一个"好机会"（label=1）

label_long = 1 if (未来5天最高价 - 今日收盘价) / 今日收盘价 >= 0.03 else 0
```

**为什么用"最大涨幅"而不是"最终收益"？**

```
假设今天价格 = 100

情况A: 明天涨到105，后天跌回98
  - 最终收益: -2%  ❌ 看起来亏了
  - 最大涨幅: +5%  ✅ 但如果有止盈，涨到105时就卖了！
  
结论: 配合止盈止损，用"最大涨幅"更合理
```

**关键参数**:
```python
future_days = 5        # 看未来5天
long_threshold = 0.03  # 3%的涨幅阈值
```

> 💡 **调参思路**: 阈值太低（如1%）→ 正样本太多，信号太泛滥；阈值太高（如10%）→ 正样本太少，模型难学

---

### 2.2 特征工程

**位置**: 第332-534行 `make_features_v2()`

**核心思想**: 用各种技术指标描述当前市场状态

**主要特征类别**:

| 类别 | 特征例子 | 含义 |
|------|---------|------|
| **动量特征** | `feat_ret_5`, `feat_ret_20` | 过去N天的涨跌幅 |
| **均线特征** | `feat_ma20_dev`, `feat_ma_align_bull` | 价格与均线的关系 |
| **波动率特征** | `feat_vol_20`, `feat_vol_contraction` | 市场波动程度 |
| **突破特征** | `feat_break_high_20`, `feat_price_pos_20` | 价格在高低点区间的位置 |
| **成交量特征** | `feat_vol_ratio_20`, `feat_vol_breakout` | 成交量变化 |
| **持仓量特征** | `feat_oi_ratio`, `feat_price_oi_bull` | 资金流向 |
| **趋势特征** | `feat_trend_slope_10`, `feat_trend_r2_10` | 趋势强度和方向 |

**特征工程的技巧**:
1. **多周期**: 同一指标用不同周期（5日、10日、20日）
2. **标准化**: 用比值而非绝对值（如价格偏离均线的百分比）
3. **防止未来信息泄露**: 只用当前和过去的数据

---

### 2.3 数据集划分

**位置**: 第541-555行 `split_data_by_year()`

```
时间线:
2015 ──────────── 2022 ──────── 2023 ──────── 2024
        训练集           验证集         测试集
      (模型学习)      (调参优化)     (最终评估)
```

**为什么按时间划分而不是随机划分？**
- 金融数据有时间顺序
- 随机划分会造成"未来信息泄露"，结果虚假乐观

---

### 2.4 模型训练

**位置**: 第567-691行 `train_model()`

**使用模型**: LightGBM（一种梯度提升决策树）

**模型做什么**:
```
输入: [feat_ret_5, feat_ma20_dev, feat_vol_20, ...]  (50个特征)
  ↓
模型学习
  ↓
输出: 0.75  (75%的概率是好机会)
```

**关键参数**:
```python
scale_pos_weight  # 正负样本比例权重，解决样本不平衡
early_stopping    # 防止过拟合，验证集不再提升就停止
```

---

### 2.5 回测系统

**位置**: 第746-953行 `backtest_v2()`

**回测逻辑**:
```
每天检查:
  1. 现有持仓是否需要平仓？
     - 止盈: 收益达到5%
     - 止损: 亏损达到2%
     - 移动止损: 从最高点回撤1.5%
     - 超时: 持仓超过10天
     
  2. 是否有新的开仓信号？
     - 多头: 模型概率 >= 阈值（top 5%）
     - 空头: 模型概率 >= 阈值（top 5%）
     - 最多同时持有5个品种
```

**风控参数**:
```python
stop_loss_pct = 0.02       # 2% 固定止损
take_profit_pct = 0.05     # 5% 固定止盈
trailing_stop_pct = 0.015  # 1.5% 移动止损
max_holding_days = 10      # 最大持仓天数
max_positions = 5          # 最大同时持仓数
```

---

## 第三章：如何评价结果

### 3.1 模型评价指标

#### AUC (Area Under Curve)

```
含义: 模型区分正负样本的能力
范围: 0.5 ~ 1.0

解读:
  0.5  = 随机猜（没用）
  0.6  = 有一点能力
  0.7  = 还不错
  0.8+ = 很好
```

#### Precision（精确率）⭐ 最重要

```
公式: 预测为正样本中，真正是正样本的比例
      = TP / (TP + FP)

含义: 模型说"是好机会"的里面，有多少真的是好机会？

交易含义: 模型发出的信号里，有多少能赚钱？

为什么最重要?
  - 我们不需要抓住所有机会（召回率低没关系）
  - 但每次交易都要尽量赚钱（精确率要高）
  - 宁可少交易，不可乱交易
```

#### Recall（召回率）

```
公式: 真正是正样本中，被模型预测为正的比例
      = TP / (TP + FN)

含义: 所有真正的好机会中，模型找到了多少？

交易含义: 市场上的好机会，能抓住多少？
```

---

### 3.2 回测评价指标

| 指标 | 计算方式 | 好的标准 | 说明 |
|-----|---------|---------|------|
| **胜率** | 盈利次数/总次数 | >50% | 多少比例的交易赚钱 |
| **盈亏比** | 平均盈利/平均亏损 | >1.5 | 每赚1元需要冒险亏多少 |
| **年化收益** | 复合年增长率 | >15% | 换算成年收益率 |
| **最大回撤** | (峰值-谷值)/峰值 | <20% | 历史最大亏损幅度 |
| **夏普比率** | 收益/波动率 | >1.0 | 风险调整后的收益 |

---

### 3.3 评判标准总结

#### ✅ 一个好策略应该满足

| 指标 | 最低要求 | 优秀 |
|-----|---------|-----|
| AUC | >0.55 | >0.65 |
| 胜率 | >45% | >55% |
| 盈亏比 | >1.2 | >1.8 |
| 夏普比率 | >0.5 | >1.5 |
| 最大回撤 | <30% | <15% |
| 年化收益 | >10% | >25% |

#### ⚠️ 重要提醒

1. **不能只看单一指标**
   - 胜率高但盈亏比低 → 可能小赚大亏
   - 年化收益高但回撤大 → 心态难以承受

2. **回测 ≠ 实盘**
   - 回测结果通常比实盘好 20-30%
   - 原因：滑点、成交延迟、市场冲击、过拟合
   - 要留足安全边际

3. **过拟合风险**
   - 训练集表现远好于测试集 → 过拟合
   - 解决：简化模型、增加正则化、交叉验证

---

## 第四章：学习路径

### 📅 推荐学习计划

#### Week 1: 理解数据和标签

**目标**: 理解"机器学习预测什么"

**任务**:
1. 运行代码，查看输出的数据形状和统计信息
2. 修改 `long_threshold` 参数（0.02, 0.03, 0.05），观察正样本比例变化
3. 思考：为什么正样本比例 20-30% 比较合理？

**阅读代码**:
- 第97-177行: `load_history_from_db()`
- 第218-274行: `assign_labels_v2()`

---

#### Week 2: 理解特征工程

**目标**: 理解"用什么信息来预测"

**任务**:
1. 学习基本技术指标的含义（推荐搜索：RSI、ATR、布林带）
2. 阅读 `make_features_v2()` 函数
3. 尝试添加一个新特征（如 MACD）

**阅读代码**:
- 第332-534行: `make_features_v2()`

**添加新特征示例**:
```python
# MACD = 12日EMA - 26日EMA
ema_12 = close.ewm(span=12).mean()
ema_26 = close.ewm(span=26).mean()
df_sym['feat_macd'] = (ema_12 - ema_26) / close  # 标准化
```

---

#### Week 3: 理解模型训练

**目标**: 理解"机器如何学习规律"

**任务**:
1. 学习决策树的基本原理（推荐搜索：决策树、梯度提升）
2. 调整模型参数，观察结果变化：
   - `max_depth`: 3, 5, 8 （越大越容易过拟合）
   - `n_estimators`: 100, 500, 1000
3. 观察特征重要性图，理解哪些特征有用

**阅读代码**:
- 第567-691行: `train_model()`

---

#### Week 4: 理解回测系统

**目标**: 理解"策略如何在历史上表现"

**任务**:
1. 仔细阅读 `backtest_v2()` 函数
2. 理解止盈、止损、移动止损的逻辑
3. 修改风控参数，观察对结果的影响：
   - `stop_loss_pct`: 0.01, 0.02, 0.03
   - `take_profit_pct`: 0.03, 0.05, 0.08

**阅读代码**:
- 第746-953行: `backtest_v2()`
- 第956-1035行: `analyze_backtest_results()`

---

### 📚 推荐学习资源

#### 机器学习基础
- 《统计学习方法》- 李航
- Coursera: Machine Learning (Andrew Ng)

#### 量化交易
- 《打开量化投资的黑箱》
- 《Python机器学习与量化投资》

#### 技术指标
- Investopedia (搜索具体指标名)
- TradingView 的指标说明

---

### 🔍 常见问题

**Q: 为什么测试集表现比训练集差很多？**
A: 可能是过拟合。解决方法：减小模型复杂度、增加正则化、减少特征数量。

**Q: 为什么回测赚钱但实盘亏钱？**
A: 可能原因：滑点、成交延迟、市场冲击、数据问题、过拟合。建议：降低预期收益20-30%。

**Q: 特征越多越好吗？**
A: 不是。太多特征会导致过拟合和噪音。建议保留重要性高的特征。

**Q: 如何判断模型是否过拟合？**
A: 比较训练集和验证集的 AUC。如果训练集 AUC=0.9 但验证集 AUC=0.55，就是严重过拟合。

---

## 🎯 最后的建议

1. **不要急于求成** - 先理解原理，再动手改代码
2. **多做实验** - 修改参数，观察结果，建立直觉
3. **保持怀疑** - 回测结果好不代表实盘能赚钱
4. **持续学习** - 量化是一个不断迭代的过程

祝学习顺利！有问题随时问。

