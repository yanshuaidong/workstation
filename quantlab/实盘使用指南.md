# 期货机器学习策略 - 实盘使用指南

## 一、策略原理简述

### 核心逻辑
这是一个**趋势预测型量化策略**，使用机器学习模型预测期货品种未来5天内是否会出现显著的单边行情。

### 预测目标
- **做多信号**：预测未来5天内最大上涨幅度 ≥ 3%
- **做空信号**：预测未来5天内最大下跌幅度 ≥ 3%

### 模型特征（共53个）
| 类别 | 特征说明 |
|------|---------|
| 价格动量 | 3/5/10/20日收益率、动量加速度 |
| 突破信号 | 10/20/40日新高新低突破、价格位置 |
| 均线系统 | 5/10/20/40/60日均线、多头/空头排列 |
| 波动率 | 短期/长期波动率、波动率收缩（突破前兆）|
| 趋势强度 | 趋势斜率、趋势得分（斜率×R²）|
| 量仓特征 | 成交量比率、持仓量变化、资金流向 |
| K线形态 | 实体占比、收盘位置、连续阳/阴线 |
| 技术指标 | RSI、布林带位置及突破 |

### 风控规则
- **止损**：亏损 2% 强制平仓
- **止盈**：盈利 5% 可平仓
- **移动止损**：从最高盈利回撤 1.5% 平仓
- **最大持仓**：10天

---

## 二、文件结构

```
quantlab/
├── futures_trend_ml.py       # 模型训练脚本
├── daily_signal_scanner.py   # 【实盘工具】每日信号扫描
├── models/
│   ├── long_model_lgbm.pkl   # 多头模型
│   └── short_model_lgbm.pkl  # 空头模型
├── portfolio/
│   └── positions.json        # 持仓记录（自动创建）
├── output/
│   ├── equity_curve.png      # 回测净值曲线
│   └── signals_*.csv         # 导出的信号
└── requirements.txt          # 依赖包
```

---

## 三、安装依赖

```bash
cd /Users/zxxk/ysd/ysdproject/workstation/quantlab
pip install -r requirements.txt
```

---

## 四、实盘使用流程

### 1. 数据更新（每日必做）

实盘数据仍然使用同一个数据库：
```
/Users/zxxk/ysd/ysdproject/workstation/database/futures/futures.db
```

你需要每天更新各品种的 `hist_xxx` 表，添加当日行情数据。

**数据格式**（与原格式一致）：
```sql
-- 每日新增一条记录
INSERT INTO hist_rbm (trade_date, open_price, high_price, low_price, close_price, volume, open_interest)
VALUES ('2024-01-15', 3850.0, 3895.0, 3820.0, 3875.0, 1234567, 2345678);
```

### 2. 扫描今日信号

```bash
# 基本用法：扫描最新数据
python daily_signal_scanner.py

# 指定日期扫描
python daily_signal_scanner.py --date 2024-01-15

# 显示更多信号
python daily_signal_scanner.py --top 20

# 导出信号到 CSV
python daily_signal_scanner.py --export
```

### 3. 管理持仓

```bash
# 查看当前持仓和风控提醒
python daily_signal_scanner.py --portfolio

# 添加持仓（手动记录你的实际交易）
python daily_signal_scanner.py --add RBM,LONG,3850.0
python daily_signal_scanner.py --add ALM,SHORT,19500.0

# 移除已平仓的品种
python daily_signal_scanner.py --remove RBM
```

---

## 五、信号解读

### 输出示例
```
📊 今日交易信号
======================================================================

多头信号: 5 个 | 空头信号: 3 个

🔺 多头信号 Top 5:
品种      概率    现价      止损      止盈      RSI
------  ------  --------  --------  --------  -----
RBM     72.35%   3850.00   3773.00   4042.50   45.2
ALM     68.12%  19500.00  19110.00  20475.00   38.7
...

🔻 空头信号 Top 3:
品种      概率    现价      止损      止盈      RSI
------  ------  --------  --------  --------  -----
CUM     65.40%  67800.00  69156.00  64410.00   62.3
...
```

### 信号筛选标准
- **概率阈值**：多头 ≥ 63%，空头 ≥ 57%（基于回测优化）
- 信号按概率从高到低排序，优先关注排名靠前的

### 参考建议
| 概率区间 | 信号强度 | 建议 |
|---------|---------|------|
| > 75% | 强信号 | 可考虑开仓 |
| 65% - 75% | 中等信号 | 结合盘面验证 |
| < 65% | 弱信号 | 谨慎观望 |

---

## 六、风控提醒示例

```
📈 持仓管理
======================================================================

⚠️  风控提醒:
  🔴 止损 [ALM] LONG
     亏损 -2.15% 触发止损
     → 建议平仓

  🟡 移动止损 [CUM] SHORT
     从最高收益 3.50% 回撤至 1.80%
     → 建议平仓

📋 当前持仓 (3 个):
品种    方向    入场价    现价      盈亏          天数  开仓日期
------  ------  --------  --------  ----------  ------  ----------
RBM     LONG    3800.00   3925.00   🟢 +3.29%        4  2024-01-10
ALM     LONG    19200.00  18790.00  🔴 -2.14%        3  2024-01-11
CUM     SHORT   68500.00  67200.00  🟢 +1.90%        5  2024-01-09
```

---

## 七、重新训练模型

当积累了足够多的新数据后，建议重新训练模型：

```bash
python futures_trend_ml.py
```

这会：
1. 重新读取全量历史数据
2. 重新训练多空模型
3. 覆盖保存到 `models/` 目录

---

## 八、回测结果参考

基于 2024-01 ~ 2025-11 测试集的表现：

| 指标 | 数值 |
|------|------|
| 总交易次数 | 1,343 |
| 胜率 | 42.29% |
| 盈亏比 | 1.81 |
| 年化收益 | 45.90% |
| 最大回撤 | 9.47% |
| 夏普比率 | 2.15 |

---

## 九、注意事项

1. **信号仅供参考**：模型预测不等于实际收益，需结合基本面和市场情绪判断
2. **严格执行风控**：止损纪律是策略盈利的核心
3. **仓位管理**：建议单品种仓位不超过总资金的 20%
4. **定期更新数据**：确保每日数据及时入库
5. **模型时效性**：建议每季度重新训练模型

---

## 十、常见问题

### Q: 模型加载失败？
```
[错误] 模型加载失败: ...
```
解决：运行 `python futures_trend_ml.py` 先训练模型

### Q: 没有任何信号？
可能原因：
- 当前市场没有符合阈值的品种（正常现象）
- 数据未更新到最新
- 阈值设置过高

### Q: 如何调整信号阈值？
修改 `daily_signal_scanner.py` 中的 `ScannerConfig`：
```python
config = ScannerConfig(
    long_threshold=0.60,   # 降低阈值会增加信号数量
    short_threshold=0.55,
    ...
)
```

