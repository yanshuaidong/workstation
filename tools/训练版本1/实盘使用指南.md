# 期货量化交易系统 - 实盘使用指南

## 📊 系统概述

本系统是一个基于机器学习的期货单边行情识别与交易策略系统，使用 LightGBM 模型预测未来 5 天的价格走势，支持多空双向交易。

### 回测表现（测试集 2024-01-02 ~ 2025-12-15）

| 指标 | 数值 |
|------|------|
| 总交易次数 | 1,173 笔 |
| 胜率 | 42.37% |
| 多头胜率 | 40.43% |
| 空头胜率 | 44.48% |
| 平均单笔收益 | 0.31% |
| 盈亏比 | 1.82 |
| 累计收益 | 86.92% |
| **年化收益** | **39.08%** |
| **最大回撤** | **6.40%** |
| 夏普比率 | 237.06% |
| 平均持仓天数 | 2.49 天 |

### 核心特点

- ✅ 双向交易：同时捕捉多头和空头机会
- ✅ 严格风控：2% 止损、5% 止盈、1.5% 移动止损
- ✅ 高信号质量：使用 top 5% 概率阈值过滤信号
- ✅ 多品种分散：支持 75+ 活跃期货品种
- ✅ 自动化管理：持仓跟踪、风控提醒、信号生成

---

## 🚀 快速开始

### 1. 环境准备

确保已安装所需依赖：

```bash
pip install -r requirements.txt
```

依赖包含：
- pandas, numpy
- scikit-learn
- lightgbm
- joblib
- tabulate
- matplotlib

### 2. 验证模型文件

确保以下文件存在：

```
quantlab/
├── models/
│   ├── long_model_lgbm.pkl    # 多头模型
│   └── short_model_lgbm.pkl   # 空头模型
├── portfolio/
│   └── positions.json          # 持仓记录（自动创建）
└── daily_signal_scanner.py     # 主程序
```

如果模型不存在，先运行训练：

```bash
python futures_trend_ml.py
```

---

## 📈 每日使用流程

### 第一步：扫描今日信号

每个交易日早盘前运行：

```bash
python daily_signal_scanner.py
```

输出示例：

```
======================================================================
🔍 期货每日信号扫描工具
======================================================================
数据库: D:\ysd\workstation\database\futures\futures.db
扫描日期: 最新
[模型] 加载成功
[数据] 发现 82 个活跃合约
[数据] 最新数据日期: 2025-12-15
[数据] 共 75 个品种
[特征] 计算中...
[特征] 完成，75 个品种
[信号] 生成中...

======================================================================
📊 今日交易信号
======================================================================

多头信号: 3 个 | 空头信号: 4 个

🔺 多头信号 Top 10:
品种    概率     现价     止损     止盈     RSI
----  ------  -------  -------  -------  -----
RB    56.42%  3520.00  3449.60  3696.00   65.3
HC    55.18%  3210.00  3145.80  3370.50   62.8
FG    54.23%  1850.00  1813.00  1942.50   58.9

🔻 空头信号 Top 10:
品种    概率     现价     止损     止盈     RSI
----  ------  -------  -------  -------  -----
AP    57.89%  7800.00  7956.00  7410.00   35.2
TA    55.67%  5420.00  5530.40  5149.00   38.5
MA    53.21%  2680.00  2733.60  2546.00   42.1
PF    52.45%  1890.00  1927.80  1795.50   40.7

======================================================================
📈 持仓管理
======================================================================

📋 当前持仓 (2 个):
品种  方向    入场价    现价      盈亏        天数  开仓日期
----  ----  -------  -------  --------  ------  ----------
AG    LONG  5320.00  5450.00  🟢 +2.44%       3  2025-12-12
NI    SHORT 13200.0  13100.0  🟢 +0.76%       1  2025-12-14

持仓平均收益: +1.60%

======================================================================
✅ 扫描完成!
======================================================================
```

### 第二步：分析信号

重点关注：

1. **概率排名**：优先考虑概率最高的信号
2. **RSI 指标**：
   - 多头信号：RSI > 50 更可靠
   - 空头信号：RSI < 50 更可靠
3. **品种特性**：优先选择熟悉的活跃品种
4. **持仓数量**：建议控制在 3-5 个品种

### 第三步：开仓决策

选择信号后，手动在交易软件开仓，然后记录到系统：

```bash
python daily_signal_scanner.py --add "RB,LONG,3520"
```

参数格式：`品种代码,方向(LONG/SHORT),开仓价格`

### 第四步：持仓管理

每日盘中或收盘后检查持仓：

```bash
python daily_signal_scanner.py --portfolio
```

根据风控提醒及时处理：

- 🔴 **止损**：亏损达 2%，立即平仓
- 🟢 **止盈**：盈利达 5%，建议平仓
- 🟡 **移动止损**：从最高点回撤 1.5%，建议平仓
- ⏰ **超时**：持仓超过 10 天，评估是否平仓

### 第五步：平仓记录

手动平仓后，从系统移除：

```bash
python daily_signal_scanner.py --remove RB
```

---

## 🎯 详细功能说明

### 信号阈值设置

当前阈值（基于测试集 top 5%）：

```python
long_threshold = 0.5342   # 多头信号阈值
short_threshold = 0.5245  # 空头信号阈值
```

这意味着只有模型预测概率超过这些阈值的信号才会被输出，确保高质量。

### 风控参数

```python
stop_loss_pct = 2%        # 固定止损
take_profit_pct = 5%      # 固定止盈
trailing_stop_pct = 1.5%  # 移动止损
max_holding_days = 10     # 最大持仓天数
max_positions = 5         # 最大持仓数量
```

### 仓位建议

根据回测结果：

- **单品种仓位**：建议 10-20% 总资金
- **总持仓**：3-5 个品种，总仓位 50-60%
- **保留资金**：至少 40% 作为风控缓冲

---

## 📋 命令行参数

### 基础用法

```bash
# 扫描今日信号
python daily_signal_scanner.py

# 指定日期扫描（回溯测试）
python daily_signal_scanner.py --date 2025-12-10

# 只查看持仓
python daily_signal_scanner.py --portfolio

# 显示更多信号（默认 Top 10）
python daily_signal_scanner.py --top 20
```

### 持仓管理

```bash
# 添加持仓
python daily_signal_scanner.py --add "RB,LONG,3520"
python daily_signal_scanner.py --add "AP,SHORT,7800"

# 移除持仓
python daily_signal_scanner.py --remove RB

# 导出信号到 CSV
python daily_signal_scanner.py --export
```

导出文件位置：`output/signals_YYYY-MM-DD.csv`

---

## ⚠️ 重要注意事项

### 1. 数据更新

**关键**：确保数据库每日更新最新行情数据。

检查数据是否最新：

```bash
# 查看数据库最新日期
python -c "import sqlite3; conn = sqlite3.connect('database/futures/futures.db'); print(conn.execute('SELECT MAX(trade_date) FROM hist_rb').fetchone())"
```

如果数据不是最新的，信号会失效！

### 2. 滑点和手续费

回测中使用 0.03% 手续费率，实际交易中注意：

- **手续费**：不同品种差异大，提前了解
- **滑点**：流动性差的品种可能有较大滑点
- **夜盘**：部分品种有夜盘，注意风险

### 3. 信号时效性

- 信号基于**收盘价**生成
- 次日开盘可能已有价格变化
- 建议开盘后观察再决策，不要盲目追单

### 4. 持仓记录同步

本系统只做**辅助决策和记录**，不直接对接交易接口。

需要手动操作：
1. 系统生成信号
2. 手动在交易软件开仓
3. 记录到系统（`--add`）
4. 系统跟踪风控
5. 手动平仓
6. 移除记录（`--remove`）

### 5. 回测 vs 实盘

回测表现不等于实盘表现，因为：

- ✗ 回测没有情绪影响
- ✗ 回测没有执行误差
- ✗ 回测没有突发事件
- ✗ 回测基于历史数据（可能过拟合）

**建议**：先小仓位验证 1-2 个月，再逐步加仓。

---

## 🔧 高级用法

### 自定义阈值

修改 `daily_signal_scanner.py` 中的阈值：

```python
config = ScannerConfig(
    long_threshold=0.60,   # 提高阈值 = 更少但更优质的信号
    short_threshold=0.58,
    stop_loss_pct=0.015,   # 调整止损为 1.5%
    take_profit_pct=0.06,  # 调整止盈为 6%
)
```

### 批量回溯测试

测试过去某段时间的信号质量：

```bash
for date in 2025-12-01 2025-12-02 2025-12-03; do
    python daily_signal_scanner.py --date $date --export
done
```

### 品种筛选

如果只想交易特定品种，可以修改代码过滤：

```python
# 在 generate_signals 函数中添加
ALLOWED_SYMBOLS = ['RB', 'HC', 'I', 'J']  # 只交易黑色系
signals = [s for s in signals if s.symbol in ALLOWED_SYMBOLS]
```

---

## 🐛 常见问题

### Q1: 提示"模型加载失败"

**A:** 先运行 `python futures_trend_ml.py` 训练模型。

### Q2: 没有信号输出

**A:** 可能的原因：
- 阈值太高，没有品种满足条件（正常）
- 数据库没有最新数据（检查数据更新）
- 尝试降低阈值或使用 `--top 20` 查看更多

### Q3: 概率分布异常

**A:** 如果所有概率都很低（< 0.3），可能是：
- 市场环境变化，模型需要重新训练
- 数据质量问题
- 建议重新训练模型

### Q4: 持仓文件丢失

**A:** 持仓记录在 `portfolio/positions.json`，如果丢失：
- 手动重建文件（JSON 格式）
- 或重新使用 `--add` 添加持仓

### Q5: 如何评估模型是否过时

**A:** 建议每 3-6 个月重新训练模型：

```bash
python futures_trend_ml.py
```

观察测试集 AUC：
- AUC > 0.70：模型有效
- AUC < 0.60：模型可能失效

---

## 📊 实盘记录建议

建议维护一个 Excel 表格记录：

| 日期 | 品种 | 方向 | 开仓价 | 平仓价 | 收益率 | 持仓天数 | 退出原因 | 备注 |
|------|------|------|--------|--------|--------|----------|----------|------|
| 2025-12-10 | RB | LONG | 3520 | 3696 | +5.0% | 3 | 止盈 | 突破新高 |
| 2025-12-11 | AP | SHORT | 7800 | 7956 | -2.0% | 1 | 止损 | 政策利好 |

定期复盘：
- 每周：统计胜率、盈亏比
- 每月：对比回测表现
- 每季度：决定是否重新训练模型

---

## 🎓 交易纪律建议

### 必须执行

1. ✅ 严格按照系统信号操作
2. ✅ 严格执行止损（2%）
3. ✅ 控制仓位（单品种 ≤ 20%）
4. ✅ 每日检查持仓风控
5. ✅ 记录每笔交易

### 不要做

1. ❌ 不要情绪化加仓
2. ❌ 不要扛单不止损
3. ❌ 不要重仓单品种
4. ❌ 不要追涨杀跌
5. ❌ 不要忽视风控提醒

### 风险提示

> ⚠️ **期货交易有风险，投资需谨慎**
> 
> 本系统仅供参考，不构成投资建议。
> 历史表现不代表未来收益。
> 建议先模拟盘验证，再实盘操作。
> 控制风险，理性投资。

---

## 📞 技术支持

如有问题，检查：

1. 日志输出（屏幕提示信息）
2. 数据库连接（`database/futures/futures.db`）
3. 持仓文件（`portfolio/positions.json`）
4. 模型文件（`models/*.pkl`）

---

**最后更新**: 2025-12-15  
**系统版本**: V2.0  
**回测日期**: 2024-01-02 ~ 2025-12-15

祝交易顺利！ 🚀

